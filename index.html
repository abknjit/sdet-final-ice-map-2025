<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Display a map on a webpage</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>
<script
  id="search-js"
  defer
  src="https://api.mapbox.com/search-js/v1.5.0/web.js">
</script>
<style>
body {
  margin: 0;
  padding: 0;
  font-family: sans-serif;
}
#map { position: absolute; top: 0; bottom: 0; width: 100%; }

/* Center banner with logo and title */
.ice-banner {
  position: absolute;
  top: 1rem;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2;
  display: inline-flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.55rem 1.2rem;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 999px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
}

.ice-banner img {
  width: 36px;
  height: auto;
  display: block;
}

.ice-banner span {
  font-weight: 700;
  letter-spacing: 0.06em;
  font-size: 1.05rem;
}

/* Popup collapse/expand */
.mapboxgl-popup-content {
  cursor: pointer;
}
.mapboxgl-popup-content .popup-body {
  display: none;
  margin-top: 4px;
  font-size: 12px;
}
.mapboxgl-popup-content.expanded .popup-body {
  display: block;
}
.mapboxgl-popup-content .popup-image {
  margin-top: 6px;
}
.mapboxgl-popup-content .popup-image img {
  max-width: 200px;
  max-height: 150px;
  border-radius: 4px;
  display: block;
}

/* Bottom-left info panel for marker details */
.info-panel {
  position: absolute;
  left: 1rem;
  bottom: 1rem;
  z-index: 2;
  width: 320px;
  max-width: 90vw;
  background: rgba(255, 255, 255, 0.96);
  border-radius: 10px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
  padding: 0.75rem 0.9rem;
  display: none;
  font-family: sans-serif;
}

.info-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}

.info-title {
  font-weight: 700;
  font-size: 1rem;
  color: #222;
}

.info-close {
  border: none;
  background: #e5e5e5;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  font-size: 16px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.info-actions {
  margin-top: 0.75rem;
  display: flex;
  justify-content: flex-end;
}

.info-delete {
  border: none;
  background: #ff4d4f;
  color: #fff;
  border-radius: 6px;
  padding: 0.4rem 0.7rem;
  cursor: pointer;
  font-weight: 600;
}

.info-body {
  margin-top: 0.5rem;
  color: #333;
  font-size: 0.9rem;
  line-height: 1.35;
}

.info-address {
  font-size: 0.9rem;
  color: #444;
  margin-top: 0.15rem;
}

.info-description {
  margin-top: 0.25rem;
}

.info-category-row {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  margin-top: 0.25rem;
  font-weight: 600;
}

.info-category-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
}

.info-dot-yellow { background: #f5c048; }
.info-dot-red { background: #e55353; }
.info-dot-purple { background: #8b6ce7; }

.info-image-wrapper {
  margin-top: 0.6rem;
}

.info-image-wrapper img {
  max-width: 100%;
  max-height: 180px;
  border-radius: 6px;
  display: block;
}

/* Left control panel */
.left-panel {
  position: absolute;
  top: 1rem;
  left: 1rem;
  z-index: 1;
  font-family: sans-serif;
}

.add-location-btn {
  padding: 0.5rem 0.9rem;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  background: #ffffff;
  color: #333;
  font-size: 0.9rem;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
}

.add-location-btn span.icon {
  font-size: 1rem;
}

.add-location-btn.active {
  background: #007bff;
  color: #ffffff;
}

/* Search panel wrapper */
.search-panel-wrapper {
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 1;
  font-family: sans-serif;
  pointer-events: none; /* Allow clicks to pass through to map, except inner container */
  display: inline-flex;
  flex-direction: column;
  align-items: flex-end;
}

.search-panel-wrapper h3 {
  margin: 0 0 0.25rem 0;
  color: #333;
  font-size: 1.05rem;
  font-weight: 600;
  text-align: right;
  pointer-events: none;
  padding: 0.15rem 0.5rem;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 999px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.16);
}

/* Make the search box container interactive */
#search-box-container {
  pointer-events: auto;
}

/* Style the MapboxSearchBox when it's in our container */
.search-panel-wrapper .mapboxgl-ctrl {
  margin: 0;
}

/* Marker details modal */
.marker-modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2;
  font-family: sans-serif;
}

.marker-modal {
  background: #ffffff;
  padding: 1.25rem 1.5rem;
  border-radius: 8px;
  width: 320px;
  max-width: 90vw;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.marker-modal h3 {
  margin-top: 0;
  margin-bottom: 0.75rem;
  font-size: 1.1rem;
}

.marker-modal label {
  display: block;
  margin-top: 0.5rem;
  margin-bottom: 0.25rem;
  font-weight: 500;
  font-size: 0.9rem;
}

.marker-modal input[type="text"],
.marker-modal textarea {
  width: 100%;
  padding: 0.45rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 0.9rem;
  box-sizing: border-box;
}

.marker-modal textarea {
  resize: vertical;
  min-height: 70px;
}

.marker-modal .address-display {
  margin-top: 0.35rem;
  font-size: 0.9rem;
  color: #444;
}

.category-row {
  margin-top: 0.75rem;
}

.category-options {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  margin-top: 0.35rem;
}

.category-option {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  cursor: pointer;
  font-size: 0.92rem;
  padding: 0.35rem 0.6rem;
  border: 1px solid #ddd;
  border-radius: 999px;
  transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
}

.category-dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  display: inline-block;
}

.dot-yellow { background: #f5c048; }
.dot-red { background: #e55353; }
.dot-purple { background: #8b6ce7; }

.category-option.selected {
  background: #f2f2f2;
  border-color: #c8c8c8;
  box-shadow: 0 1px 3px rgba(0,0,0,0.12);
}

.marker-modal input[type="file"] {
  margin-top: 0.25rem;
  font-size: 0.85rem;
}

.marker-modal-actions {
  margin-top: 1rem;
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.marker-modal button {
  padding: 0.45rem 0.9rem;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  font-size: 0.9rem;
}

.marker-modal button.primary {
  background: #007bff;
  color: #fff;
}

.marker-modal button.secondary {
  background: #e0e0e0;
  color: #333;
}
</style>
</head>
<body>
<div id="map"></div>

<!-- Center banner -->
<div class="ice-banner">
  <!-- Make sure Untitled.svg is in your deployed public root (e.g., /public/Untitled.svg on Vercel) -->
  <img src="/Untitled.svg" alt="Ice logo" />
  <span>ICE TRACKER</span>
</div>

<!-- Bottom-left info panel for marker details -->
<div class="info-panel" id="info-panel">
  <div class="info-header">
    <div class="info-title" id="info-title">Location</div>
    <button class="info-close" id="info-close" aria-label="Close details">×</button>
  </div>
  <div class="info-body">
    <div class="info-address" id="info-address"></div>
    <div class="info-category-row" id="info-category-row" style="display:none;">
      <span class="info-category-dot" id="info-category-dot"></span>
      <span class="info-category-text" id="info-category-text"></span>
    </div>
    <div class="info-description" id="info-description"></div>
    <div class="info-image-wrapper" id="info-image-wrapper" style="display:none;">
      <img id="info-image" alt="Location photo" />
    </div>
  </div>
  <div class="info-actions">
    <button class="info-delete" id="info-delete" aria-label="Delete marker">Delete</button>
  </div>
</div>

<!-- Left-side controls -->
<div class="left-panel">
  <button id="add-location-toggle" class="add-location-btn">
    <span class="icon">＋</span>
    <span>Add location</span>
  </button>
</div>

<!-- Search panel wrapper -->
<div class="search-panel-wrapper">
  <h3>Location Search</h3>
  <div id="search-box-container"></div>
</div>

<!-- Marker details modal -->
<div class="marker-modal-backdrop" id="marker-modal-backdrop">
  <div class="marker-modal">
    <h3>Report a Sighting</h3>
    <form id="marker-form">
      
        <label>Address</label>
      <div class="address-display" id="marker-address-display">Fetching address…</div>
      
       <div class="category-row">
         <label>Category</label>
         <div class="category-options" id="marker-category-group">
           <label class="category-option">
             <input type="radio" name="marker-category" value="surveying" checked />
             <span class="category-dot dot-yellow"></span>
             <span>Warning / Sighting</span>
           </label>
           <label class="category-option">
             <input type="radio" name="marker-category" value="harassment" />
             <span class="category-dot dot-red"></span>
             <span>Questioned / Harassment</span>
           </label>
           <label class="category-option">
             <input type="radio" name="marker-category" value="abduction" />
             <span class="category-dot dot-purple"></span>
             <span>Abduction / Detainment</span>
           </label>
         </div>
       </div>

        <label for="marker-title">Title</label>
      <input type="text" id="marker-title" name="marker-title" placeholder="Location title" required />

      <label for="marker-description">Description</label>
      <textarea id="marker-description" name="marker-description" placeholder="Describe the situation"></textarea>


      <label for="marker-photo">Photo (optional)</label>
      <input type="file" id="marker-photo" name="marker-photo" accept="image/*" />

      <div class="marker-modal-actions">
        <button type="button" class="secondary" id="marker-cancel">Cancel</button>
        <button type="submit" class="primary">Save Marker</button>
      </div>
    </form>
  </div>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXNhYmtrIiwiYSI6ImNtajFqd2thaTAxaHozY29iMWw0Zm5qOGsifQ.BnE4QsgeWCaiNwzZvWYouQ';
    const map = new mapboxgl.Map({
        container: 'map', // container ID
        style: 'mapbox://styles/mapbox/streets-v12', // map style
        center: [-98.5, 39.8], // center over the continental US
        zoom: 3, // zoomed out to show most of the US
        // restrict panning to the continental United States (tighter bounding box)
        maxBounds: [
            [-125, 24], // southwest coordinates [lng, lat]
            [-66, 50]   // northeast coordinates [lng, lat]
        ]
    });

    // Store marker references
    let currentMarker = null; // used for search/autofill markers
    // Store MapboxSearchBox reference
    let mapboxSearchBox = null;
    // Store coordinates for marker being created
    let pendingMarkerCoords = null;
    let pendingMarkerAddress = '';
    // Whether we are currently in "add location" mode
    let addLocationMode = false;
    // Local storage key for saved markers
    const MARKERS_STORAGE_KEY = 'ice-map-markers';

    // In-memory list of saved markers
    let savedMarkers = [];
    // Map markerId -> mapbox marker instance for removal
    const markerRefs = new Map();

    // Left panel toggle for adding locations
    const addLocationToggle = document.getElementById('add-location-toggle');
    addLocationToggle.addEventListener('click', () => {
        addLocationMode = !addLocationMode;
        addLocationToggle.classList.toggle('active', addLocationMode);
    });

    // Utility: open/close marker modal
    const markerModalBackdrop = document.getElementById('marker-modal-backdrop');
    const markerForm = document.getElementById('marker-form');
    const markerTitleInput = document.getElementById('marker-title');
    const markerDescriptionInput = document.getElementById('marker-description');
    const markerPhotoInput = document.getElementById('marker-photo');
    const markerCancelButton = document.getElementById('marker-cancel');
    const markerAddressDisplay = document.getElementById('marker-address-display');
    const markerCategoryGroup = document.getElementById('marker-category-group');

    // Info panel elements
    const infoPanel = document.getElementById('info-panel');
    const infoTitle = document.getElementById('info-title');
    const infoAddress = document.getElementById('info-address');
    const infoCategoryRow = document.getElementById('info-category-row');
    const infoCategoryDot = document.getElementById('info-category-dot');
    const infoCategoryText = document.getElementById('info-category-text');
    const infoDescription = document.getElementById('info-description');
    const infoImageWrapper = document.getElementById('info-image-wrapper');
    const infoImage = document.getElementById('info-image');
    const infoClose = document.getElementById('info-close');
    const infoDelete = document.getElementById('info-delete');

    let infoPanelMarkerId = null; // track which marker is currently shown

    // Simple marker id generator
    function makeMarkerId() {
        return `m-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    }

    function openMarkerModal(coords) {
        pendingMarkerCoords = coords;
        pendingMarkerAddress = '';
        markerTitleInput.value = '';
        markerDescriptionInput.value = '';
        markerPhotoInput.value = '';
        markerAddressDisplay.textContent = 'Fetching address…';
        // reset category selection to default (first/checked)
        const defaultCategory = markerCategoryGroup.querySelector('input[name="marker-category"]');
        if (defaultCategory) {
            defaultCategory.checked = true;
            updateCategoryHighlight();
        }
        markerModalBackdrop.style.display = 'flex';

        // Reverse geocode for display
        const geocodeUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?access_token=${mapboxgl.accessToken}&limit=1`;
        fetch(geocodeUrl)
            .then(res => res.json())
            .then(data => {
                const addr = (data.features && data.features[0] && data.features[0].place_name) ? data.features[0].place_name : 'Address not found';
                pendingMarkerAddress = addr === 'Address not found' ? '' : addr;
                markerAddressDisplay.textContent = addr;
            })
            .catch(() => {
                pendingMarkerAddress = '';
                markerAddressDisplay.textContent = 'Address not found';
            });
    }

    function closeMarkerModal() {
        markerModalBackdrop.style.display = 'none';
        pendingMarkerCoords = null;
    }

    function categoryDisplay(category) {
        switch (category) {
            case 'harassment':
                return { text: 'Questioned / Harassment', dotClass: 'info-dot-red' };
            case 'abduction':
                return { text: 'Abduction / Detainment', dotClass: 'info-dot-purple' };
            case 'surveying':
            default:
                return { text: 'Warning / Sighting', dotClass: 'info-dot-yellow' };
        }
    }

    // Show info panel with marker details
    function showInfoPanel(markerId, title, description, imageDataUrl, address, category) {
        const cat = categoryDisplay(category);
        infoTitle.textContent = title || 'Location';
        infoAddress.textContent = address || '';
        infoCategoryDot.className = `info-category-dot ${cat.dotClass}`;
        infoCategoryText.textContent = cat.text;
        infoCategoryRow.style.display = 'flex';
        infoDescription.textContent = description || '';

        if (imageDataUrl) {
            infoImageWrapper.style.display = 'block';
            infoImage.src = imageDataUrl;
            infoImage.alt = title || 'Location photo';
        } else {
            infoImageWrapper.style.display = 'none';
            infoImage.src = '';
        }

        infoPanel.style.display = 'block';
        infoPanelMarkerId = markerId;
    }

    function hideInfoPanel() {
        infoPanel.style.display = 'none';
        infoPanelMarkerId = null;
    }

    infoClose.addEventListener('click', hideInfoPanel);
    infoDelete.addEventListener('click', () => {
        if (!infoPanelMarkerId) return;
        // Remove marker instance from map
        const marker = markerRefs.get(infoPanelMarkerId);
        if (marker) {
            marker.remove();
            markerRefs.delete(infoPanelMarkerId);
        }
        // Remove from saved list
        savedMarkers = savedMarkers.filter((m) => m.id !== infoPanelMarkerId);
        saveMarkers();
        hideInfoPanel();
    });

    // Update category selection highlighting
    function updateCategoryHighlight() {
        const options = markerCategoryGroup.querySelectorAll('.category-option');
        options.forEach((opt) => {
            const input = opt.querySelector('input[name="marker-category"]');
            opt.classList.toggle('selected', input && input.checked);
        });
    }

    markerCategoryGroup.addEventListener('change', updateCategoryHighlight);
    infoDelete.addEventListener('click', () => {
        if (!infoPanelMarkerId) return;
        // Remove marker instance from map
        const marker = markerRefs.get(infoPanelMarkerId);
        if (marker) {
            marker.remove();
            markerRefs.delete(infoPanelMarkerId);
        }
        // Remove from saved list
        savedMarkers = savedMarkers.filter((m) => m.id !== infoPanelMarkerId);
        saveMarkers();
        hideInfoPanel();
    });

    // Attach click handler to a marker to toggle the info panel
    function attachMarkerInfo(marker, data, markerId) {
        const el = marker.getElement();
        el.style.cursor = 'pointer';
        el.addEventListener('click', (e) => {
            e.stopPropagation();
            if (infoPanelMarkerId === markerId && infoPanel.style.display === 'block') {
                hideInfoPanel();
            } else {
                showInfoPanel(markerId, data.title, data.description, data.imageDataUrl, data.address, data.category);
            }
        });
        markerRefs.set(markerId, marker);
    }

    // Load saved markers from localStorage and add them to the map
    function loadSavedMarkers() {
        try {
            const raw = localStorage.getItem(MARKERS_STORAGE_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);
            if (!Array.isArray(data)) return;
            savedMarkers = data;

            data.forEach((m, idx) => {
                if (!m || typeof m.lng !== 'number' || typeof m.lat !== 'number') return;
                const title = m.title || 'Untitled location';
                const description = m.description || '';
                const imageDataUrl = m.imageDataUrl || null;
                const address = m.address || '';
                const markerId = m.id || makeMarkerId();
                if (!m.id) {
                    savedMarkers[idx] = { ...m, id: markerId };
                }

                const marker = new mapboxgl.Marker()
                    .setLngLat([m.lng, m.lat])
                    .addTo(map);

                attachMarkerInfo(marker, { title, description, imageDataUrl, address, category: m.category || 'surveying' }, markerId);
            });

            // Persist newly assigned ids, if any
            saveMarkers();
        } catch (e) {
            console.error('Error loading saved markers:', e);
        }
    }

    // Save current markers list to localStorage
    function saveMarkers() {
        try {
            localStorage.setItem(MARKERS_STORAGE_KEY, JSON.stringify(savedMarkers));
        } catch (e) {
            console.error('Error saving markers:', e);
        }
    }

    // Function to geocode address and zoom to location (kept for reuse if needed)
    function searchAndZoom() {
        const addressInput = document.querySelector('input[name="address"]');
        const cityInput = document.getElementById('city');
        const stateInput = document.getElementById('state');
        const postcodeInput = document.getElementById('postcode');

        // Build query string from form inputs
        const addressParts = [];
        if (addressInput.value) addressParts.push(addressInput.value);
        if (cityInput.value) addressParts.push(cityInput.value);
        if (stateInput.value) addressParts.push(stateInput.value);
        if (postcodeInput.value) addressParts.push(postcodeInput.value);

        if (addressParts.length === 0) {
            alert('Please enter an address');
            return;
        }

        const query = addressParts.join(', ');

        // Use Mapbox Geocoding API
        const geocodingUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&country=US&limit=1`;

        fetch(geocodingUrl)
            .then(response => response.json())
            .then(data => {
                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    const [lng, lat] = feature.center;

                    // Remove existing marker
                    if (currentMarker) {
                        currentMarker.remove();
                    }

                    // Add new marker
                    currentMarker = new mapboxgl.Marker()
                        .setLngLat([lng, lat])
                        .addTo(map);

                    // Zoom and pan to the location with smooth animation
                    map.flyTo({
                        center: [lng, lat],
                        zoom: 15,
                        duration: 2000,
                        essential: true // This ensures the animation completes
                    });

                    // Populate the MapboxSearchBox with the search query
                    if (mapboxSearchBox) {
                        // Wait a moment for the search box to be fully rendered
                        setTimeout(() => {
                            // Try multiple selectors to find the search input
                            const searchBoxInput = document.querySelector('.mapboxgl-ctrl-geocoder input[type="text"]') ||
                                                   document.querySelector('.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input') ||
                                                   document.querySelector('.mapboxgl-ctrl-geocoder input');
                            
                            if (searchBoxInput) {
                                searchBoxInput.value = query;
                                // Trigger input event to show suggestions
                                const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                                searchBoxInput.dispatchEvent(inputEvent);
                                
                                // Also try to trigger the search box's search method if available
                                if (mapboxSearchBox._geocoder) {
                                    mapboxSearchBox._geocoder.query(query);
                                }
                            }
                        }, 100);
                    }
                } else {
                    alert('Address not found. Please try a different address.');
                }
            })
            .catch(error => {
                console.error('Geocoding error:', error);
                alert('Error searching for address. Please try again.');
            });
    }

    // Handle marker form submission
    markerForm.addEventListener('submit', (event) => {
        event.preventDefault();
        if (!pendingMarkerCoords) {
            closeMarkerModal();
            return;
        }

        const title = markerTitleInput.value.trim() || 'Untitled location';
        const description = markerDescriptionInput.value.trim();
        const file = markerPhotoInput.files[0];

        const [lng, lat] = pendingMarkerCoords;

        function createMarkerWithPopup(imageDataUrl, addressText, markerId) {
            const marker = new mapboxgl.Marker()
                .setLngLat([lng, lat])
                .addTo(map);

            attachMarkerInfo(marker, { title, description, imageDataUrl, address: addressText }, markerId);
        }

        const persistMarker = (imageDataUrl, addressText) => {
            const categoryInput = markerCategoryGroup.querySelector('input[name="marker-category"]:checked');
            const category = categoryInput ? categoryInput.value : 'surveying';
            const markerId = makeMarkerId();
            createMarkerWithPopup(imageDataUrl, addressText, markerId);
            savedMarkers.push({
                id: markerId,
                lng,
                lat,
                title,
                description,
                imageDataUrl,
                address: addressText || '',
                category
            });
            saveMarkers();
        };

        const proceedWithAddress = (addressText) => {
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageDataUrl = e.target.result;
                    persistMarker(imageDataUrl, addressText);
                };
                reader.readAsDataURL(file);
            } else {
                persistMarker(null, addressText);
            }
        };

        // Reverse geocode to fetch address, then save
        if (pendingMarkerAddress) {
            proceedWithAddress(pendingMarkerAddress);
        } else {
            const geocodingUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}&limit=1`;
            fetch(geocodingUrl)
                .then((response) => response.json())
                .then((data) => {
                    const addressText = (data.features && data.features[0] && data.features[0].place_name) ? data.features[0].place_name : '';
                    proceedWithAddress(addressText);
                })
                .catch(() => {
                    proceedWithAddress('');
                });
        }

        closeMarkerModal();

        // After saving, turn off add-location mode
        addLocationMode = false;
        addLocationToggle.classList.remove('active');
    });

    // Cancel button closes the modal without creating a marker
    markerCancelButton.addEventListener('click', () => {
        closeMarkerModal();

        // Cancel also exits add-location mode
        addLocationMode = false;
        addLocationToggle.classList.remove('active');
    });

    // Click on the map to start adding a marker only when add-location is enabled
    map.on('click', (e) => {
        if (!addLocationMode) {
            return;
        }
        const coords = [e.lngLat.lng, e.lngLat.lat];
        openMarkerModal(coords);
    });

    // Load any previously-saved markers once the map is ready
    map.on('load', () => {
        loadSavedMarkers();
    });

    // Initialize Mapbox Search autofill when the search-js script has loaded
    const searchScript = document.getElementById('search-js');
    searchScript.onload = function () {
        if (window.mapboxsearch && mapboxsearch.autofill) {
            const autofill = mapboxsearch.autofill({
                accessToken: 'pk.eyJ1IjoiYXNhYmtrIiwiYSI6ImNtajFqd2thaTAxaHozY29iMWw0Zm5qOGsifQ.BnE4QsgeWCaiNwzZvWYouQ'
            });

            // Listen for when an address is selected/retrieved from autofill
            autofill.addEventListener('retrieve', (event) => {
                const feature = event.detail;
                if (feature && feature.geometry && feature.geometry.coordinates) {
                    const [lng, lat] = feature.geometry.coordinates;
                    
                    // Remove existing marker
                    if (currentMarker) {
                        currentMarker.remove();
                    }

                    // Add new marker
                    currentMarker = new mapboxgl.Marker()
                        .setLngLat([lng, lat])
                        .addTo(map);

                    // Zoom and pan to the selected location with smooth animation
                    map.flyTo({
                        center: [lng, lat],
                        zoom: 15,
                        duration: 2000,
                        essential: true // This ensures the animation completes
                    });
                }
            });
        }

        // Add MapboxSearchBox for automatic zoom functionality (waits for window load)
        window.addEventListener('load', () => {
            if (window.MapboxSearchBox) {
                mapboxSearchBox = new MapboxSearchBox();
                mapboxSearchBox.accessToken = 'pk.eyJ1IjoiYXNhYmtrIiwiYSI6ImNtajFqd2thaTAxaHozY29iMWw0Zm5qOGsifQ.BnE4QsgeWCaiNwzZvWYouQ';
                mapboxSearchBox.options = {
                    types: 'address,poi',
                    proximity: [-98.5, 39.8], // Center of US
                    country: 'US' // Restrict to US
                };
                mapboxSearchBox.marker = true;
                mapboxSearchBox.mapboxgl = mapboxgl;
                mapboxSearchBox.componentOptions = { allowReverse: true, flipCoordinates: true };
                
                // Add the search box to our custom container
                const searchContainer = document.getElementById('search-box-container');
                if (searchContainer) {
                    const searchBoxElement = mapboxSearchBox.onAdd(map);
                    searchContainer.appendChild(searchBoxElement);
                } else {
                    // Fallback to standard map control
                    map.addControl(mapboxSearchBox, 'top-right');
                }
            }
        });
    };

</script>

</body>
</html>
