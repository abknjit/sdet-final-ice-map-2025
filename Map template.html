<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Display a map on a webpage</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>
<script
  id="search-js"
  defer
  src="https://api.mapbox.com/search-js/v1.5.0/web.js">
</script>
<style>
body {
  margin: 0;
  padding: 0;
  font-family: sans-serif;
}
#map { position: absolute; top: 0; bottom: 0; width: 100%; }

/* Left control panel */
.left-panel {
  position: absolute;
  top: 1rem;
  left: 1rem;
  z-index: 1;
  font-family: sans-serif;
}

.add-location-btn {
  padding: 0.5rem 0.9rem;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  background: #ffffff;
  color: #333;
  font-size: 0.9rem;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
}

.add-location-btn span.icon {
  font-size: 1rem;
}

.add-location-btn.active {
  background: #007bff;
  color: #ffffff;
}

/* Search panel wrapper */
.search-panel-wrapper {
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 1;
  font-family: sans-serif;
  pointer-events: none; /* Allow clicks to pass through to map */
}

.search-panel-wrapper h3 {
  margin: 0 0 0.5rem 0;
  color: #333;
  font-size: 1.1rem;
  font-weight: 600;
  text-align: right;
  pointer-events: none;
}

/* Make the search box container interactive */
#search-box-container {
  pointer-events: auto;
}

/* Style the MapboxSearchBox when it's in our container */
.search-panel-wrapper .mapboxgl-ctrl {
  margin: 0;
}

/* Marker details modal */
.marker-modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2;
  font-family: sans-serif;
}

.marker-modal {
  background: #ffffff;
  padding: 1.25rem 1.5rem;
  border-radius: 8px;
  width: 320px;
  max-width: 90vw;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.marker-modal h3 {
  margin-top: 0;
  margin-bottom: 0.75rem;
  font-size: 1.1rem;
}

.marker-modal label {
  display: block;
  margin-top: 0.5rem;
  margin-bottom: 0.25rem;
  font-weight: 500;
  font-size: 0.9rem;
}

.marker-modal input[type="text"],
.marker-modal textarea {
  width: 100%;
  padding: 0.45rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 0.9rem;
  box-sizing: border-box;
}

.marker-modal textarea {
  resize: vertical;
  min-height: 70px;
}

.marker-modal input[type="file"] {
  margin-top: 0.25rem;
  font-size: 0.85rem;
}

.marker-modal-actions {
  margin-top: 1rem;
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.marker-modal button {
  padding: 0.45rem 0.9rem;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  font-size: 0.9rem;
}

.marker-modal button.primary {
  background: #007bff;
  color: #fff;
}

.marker-modal button.secondary {
  background: #e0e0e0;
  color: #333;
}
</style>
</head>
<body>
<div id="map"></div>

<!-- Left-side controls -->
<div class="left-panel">
  <button id="add-location-toggle" class="add-location-btn">
    <span class="icon">ï¼‹</span>
    <span>Add location</span>
  </button>
</div>

<!-- Search panel wrapper -->
<div class="search-panel-wrapper">
  <h3>Location Search</h3>
  <div id="search-box-container"></div>
</div>

<!-- Marker details modal -->
<div class="marker-modal-backdrop" id="marker-modal-backdrop">
  <div class="marker-modal">
    <h3>Add Marker Details</h3>
    <form id="marker-form">
      <label for="marker-title">Title</label>
      <input type="text" id="marker-title" name="marker-title" placeholder="Location title" required />

      <label for="marker-description">Description</label>
      <textarea id="marker-description" name="marker-description" placeholder="Describe this location"></textarea>

      <label for="marker-photo">Photo (optional)</label>
      <input type="file" id="marker-photo" name="marker-photo" accept="image/*" />

      <div class="marker-modal-actions">
        <button type="button" class="secondary" id="marker-cancel">Cancel</button>
        <button type="submit" class="primary">Save Marker</button>
      </div>
    </form>
  </div>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXNhYmtrIiwiYSI6ImNtajFqd2thaTAxaHozY29iMWw0Zm5qOGsifQ.BnE4QsgeWCaiNwzZvWYouQ';
    const map = new mapboxgl.Map({
        container: 'map', // container ID
        style: 'mapbox://styles/mapbox/streets-v12', // map style
        center: [-98.5, 39.8], // center over the continental US
        zoom: 3, // zoomed out to show most of the US
        // restrict panning to the continental United States (tighter bounding box)
        maxBounds: [
            [-125, 24], // southwest coordinates [lng, lat]
            [-66, 50]   // northeast coordinates [lng, lat]
        ]
    });

    // Store marker references
    let currentMarker = null;
    // Store MapboxSearchBox reference
    let mapboxSearchBox = null;
    // Store coordinates for marker being created
    let pendingMarkerCoords = null;
    // Whether we are currently in "add location" mode
    let addLocationMode = false;

    // Left panel toggle for adding locations
    const addLocationToggle = document.getElementById('add-location-toggle');
    addLocationToggle.addEventListener('click', () => {
        addLocationMode = !addLocationMode;
        addLocationToggle.classList.toggle('active', addLocationMode);
    });

    // Utility: open/close marker modal
    const markerModalBackdrop = document.getElementById('marker-modal-backdrop');
    const markerForm = document.getElementById('marker-form');
    const markerTitleInput = document.getElementById('marker-title');
    const markerDescriptionInput = document.getElementById('marker-description');
    const markerPhotoInput = document.getElementById('marker-photo');
    const markerCancelButton = document.getElementById('marker-cancel');

    function openMarkerModal(coords) {
        pendingMarkerCoords = coords;
        markerTitleInput.value = '';
        markerDescriptionInput.value = '';
        markerPhotoInput.value = '';
        markerModalBackdrop.style.display = 'flex';
    }

    function closeMarkerModal() {
        markerModalBackdrop.style.display = 'none';
        pendingMarkerCoords = null;
    }

    // Function to geocode address and zoom to location (kept for reuse if needed)
    function searchAndZoom() {
        const addressInput = document.querySelector('input[name="address"]');
        const cityInput = document.getElementById('city');
        const stateInput = document.getElementById('state');
        const postcodeInput = document.getElementById('postcode');

        // Build query string from form inputs
        const addressParts = [];
        if (addressInput.value) addressParts.push(addressInput.value);
        if (cityInput.value) addressParts.push(cityInput.value);
        if (stateInput.value) addressParts.push(stateInput.value);
        if (postcodeInput.value) addressParts.push(postcodeInput.value);

        if (addressParts.length === 0) {
            alert('Please enter an address');
            return;
        }

        const query = addressParts.join(', ');

        // Use Mapbox Geocoding API
        const geocodingUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&country=US&limit=1`;

        fetch(geocodingUrl)
            .then(response => response.json())
            .then(data => {
                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    const [lng, lat] = feature.center;

                    // Remove existing marker
                    if (currentMarker) {
                        currentMarker.remove();
                    }

                    // Add new marker
                    currentMarker = new mapboxgl.Marker()
                        .setLngLat([lng, lat])
                        .addTo(map);

                    // Zoom and pan to the location with smooth animation
                    map.flyTo({
                        center: [lng, lat],
                        zoom: 15,
                        duration: 2000,
                        essential: true // This ensures the animation completes
                    });

                    // Populate the MapboxSearchBox with the search query
                    if (mapboxSearchBox) {
                        // Wait a moment for the search box to be fully rendered
                        setTimeout(() => {
                            // Try multiple selectors to find the search input
                            const searchBoxInput = document.querySelector('.mapboxgl-ctrl-geocoder input[type="text"]') ||
                                                   document.querySelector('.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input') ||
                                                   document.querySelector('.mapboxgl-ctrl-geocoder input');
                            
                            if (searchBoxInput) {
                                searchBoxInput.value = query;
                                // Trigger input event to show suggestions
                                const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                                searchBoxInput.dispatchEvent(inputEvent);
                                
                                // Also try to trigger the search box's search method if available
                                if (mapboxSearchBox._geocoder) {
                                    mapboxSearchBox._geocoder.query(query);
                                }
                            }
                        }, 100);
                    }
                } else {
                    alert('Address not found. Please try a different address.');
                }
            })
            .catch(error => {
                console.error('Geocoding error:', error);
                alert('Error searching for address. Please try again.');
            });
    }

    // Handle marker form submission
    markerForm.addEventListener('submit', (event) => {
        event.preventDefault();
        if (!pendingMarkerCoords) {
            closeMarkerModal();
            return;
        }

        const title = markerTitleInput.value.trim() || 'Untitled location';
        const description = markerDescriptionInput.value.trim();
        const file = markerPhotoInput.files[0];

        const [lng, lat] = pendingMarkerCoords;

        function createMarkerWithPopup(imageDataUrl) {
            const popupContentParts = [`<strong>${title}</strong>`];
            if (description) {
                popupContentParts.push(`<div style="margin-top:4px; font-size:12px;">${description}</div>`);
            }
            if (imageDataUrl) {
                popupContentParts.push(`<div style="margin-top:6px;"><img src="${imageDataUrl}" alt="Location photo" style="max-width:200px; max-height:150px; border-radius:4px;"></div>`);
            }

            const popup = new mapboxgl.Popup({ offset: 24 })
                .setHTML(popupContentParts.join(''));

            new mapboxgl.Marker()
                .setLngLat([lng, lat])
                .setPopup(popup)
                .addTo(map);

            popup.addTo(map);
        }

        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                createMarkerWithPopup(e.target.result);
            };
            reader.readAsDataURL(file);
        } else {
            createMarkerWithPopup(null);
        }

        closeMarkerModal();

        // After saving, turn off add-location mode
        addLocationMode = false;
        addLocationToggle.classList.remove('active');
    });

    // Cancel button closes the modal without creating a marker
    markerCancelButton.addEventListener('click', () => {
        closeMarkerModal();

        // Cancel also exits add-location mode
        addLocationMode = false;
        addLocationToggle.classList.remove('active');
    });

    // Click on the map to start adding a marker only when add-location is enabled
    map.on('click', (e) => {
        if (!addLocationMode) {
            return;
        }
        const coords = [e.lngLat.lng, e.lngLat.lat];
        openMarkerModal(coords);
    });

    // Initialize Mapbox Search autofill when the search-js script has loaded
    const searchScript = document.getElementById('search-js');
    searchScript.onload = function () {
        if (window.mapboxsearch && mapboxsearch.autofill) {
            const autofill = mapboxsearch.autofill({
                accessToken: 'pk.eyJ1IjoiYXNhYmtrIiwiYSI6ImNtajFqd2thaTAxaHozY29iMWw0Zm5qOGsifQ.BnE4QsgeWCaiNwzZvWYouQ'
            });

            // Listen for when an address is selected/retrieved from autofill
            autofill.addEventListener('retrieve', (event) => {
                const feature = event.detail;
                if (feature && feature.geometry && feature.geometry.coordinates) {
                    const [lng, lat] = feature.geometry.coordinates;
                    
                    // Remove existing marker
                    if (currentMarker) {
                        currentMarker.remove();
                    }

                    // Add new marker
                    currentMarker = new mapboxgl.Marker()
                        .setLngLat([lng, lat])
                        .addTo(map);

                    // Zoom and pan to the selected location with smooth animation
                    map.flyTo({
                        center: [lng, lat],
                        zoom: 15,
                        duration: 2000,
                        essential: true // This ensures the animation completes
                    });
                }
            });
        }

        // Add MapboxSearchBox for automatic zoom functionality (waits for window load)
        window.addEventListener('load', () => {
            if (window.MapboxSearchBox) {
                mapboxSearchBox = new MapboxSearchBox();
                mapboxSearchBox.accessToken = 'pk.eyJ1IjoiYXNhYmtrIiwiYSI6ImNtajFqd2thaTAxaHozY29iMWw0Zm5qOGsifQ.BnE4QsgeWCaiNwzZvWYouQ';
                mapboxSearchBox.options = {
                    types: 'address,poi',
                    proximity: [-98.5, 39.8], // Center of US
                    country: 'US' // Restrict to US
                };
                mapboxSearchBox.marker = true;
                mapboxSearchBox.mapboxgl = mapboxgl;
                mapboxSearchBox.componentOptions = { allowReverse: true, flipCoordinates: true };
                
                // Add the search box to our custom container
                const searchContainer = document.getElementById('search-box-container');
                if (searchContainer) {
                    const searchBoxElement = mapboxSearchBox.onAdd(map);
                    searchContainer.appendChild(searchBoxElement);
                } else {
                    // Fallback to standard map control
                    map.addControl(mapboxSearchBox, 'top-right');
                }
            }
        });
    };

</script>

</body>
</html>
